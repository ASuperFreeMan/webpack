export var bustard
export var loader
export var sprite
export var pick
export var color
export var textureTool
export var modelHide
export var FlowImgUrl1
export var FlowImgUrl2
export var datas
export var renderInterval
export var stationName
export var STATION_MODEL_ALL
export var bengzhan = {

    //春兰
    chunlanStation: {
        qiang: [
            {
                start: 2,
                end: 11
            }
        ],
        controlBox: [
            {
                start: 44,
                end: 47
            }
        ],
        wushuibeng: [
            {
                name: "污水泵1",
                index: 19
            },
            {
                name: "污水泵2",
                index: 20
            },
            {
                name: "污水泵3",
                index: 21
            },
            {
                name: "污水泵4",
                index: 22
            }
        ],
        pipeNodeNames: [
            {
                index1: 23,
                index2: 28,
                index3: 35,
                index4: 33,
                index5: 43
            },
            {
                index1: 24,
                index2: 27,
                index3: 34,
                index4: 37,
                index5: 42
            },
            {
                index1: 25,
                index2: 29,
                index3: 31,
                index4: 32,
                index5: 41
            },
            {
                index1: 26,
                index2: 30,
                index3: 36,
                index4: 38,
                index5: 40
            }
        ],
        mainPipelineIndex: [
            39
        ],
        laozhaji: [
            {
                name: "捞渣机1",
                index: 52
            },
            {
                name: "捞渣机1",
                index: 50
            }
        ],
        chuansongdai: [
            {
                name: "传送带1",
                index: 56
            },
            {
                name: "传送带2",
                index: 55
            }
        ],
        qibiji: [
            {
                name: "启闭机1",
                index: 49
            },
            {
                name: "启闭机2",
                index: 48
            }
        ],
        lajichuansongji: [
            {
                name: "垃圾传送机1",
                index: 51
            },
        ]
    },

    //三号小区
    districtthreeStation: {
        qiang: [
            {
                start: 1,
                end: 9
            }
        ],
        controlBox: [
            {
                start: 25,
                end: 26
            }
        ],
        wushuibeng: [
            {
                name: "污水泵1",
                index: 12
            },
            {
                name: "污水泵2",
                index: 13
            }
        ],
        pipeNodeNames: [
            {
                index1: 14,
                index2: 17,
                index3: 20,
                index4: 18,
                index5: 24
            },
            {
                index1: 15,
                index2: 16,
                index3: 19,
                index4: 21,
                index5: 23
            }
        ],
        mainPipelineIndex: [
            22
        ],
        laozhaji: [

        ],
        qibiji: [

        ],
        lajichuansongji: [

        ]
    },

    //东风
    eastwindStation: {
        qiang: [
            {
                start: 1,
                end: 9
            }
        ],
        controlBox: [
            {
                start: 31,
                end: 33
            }
        ],
        wushuibeng: [
            {
                name: "污水泵1",
                index: 12
            },
            {
                name: "污水泵2",
                index: 13
            },
            {
                name: "污水泵3",
                index: 14
            }
        ],
        pipeNodeNames: [
            {
                index1: 15,
                index2: 19,
                index3: 25,
                index4: 23,
                index5: 30
            },
            {
                index1: 16,
                index2: 18,
                index3: 24,
                index4: 26,
                index5: 28
            },
            {
                index1: 17,
                index2: 20,
                index3: 21,
                index4: 22,
                index5: 29
            }
        ],
        mainPipelineIndex: [
            27
        ],
        laozhaji: [

        ],
        qibiji: [

        ],
        lajichuansongji: [

        ]
    },

    //鼓楼
    gulouStation: {
        qiang: [
            {
                start: 2,
                end: 11
            }
        ],
        controlBox: [
            {
                start: 44,
                end: 47
            }
        ],
        wushuibeng: [
            {
                name: "污水泵1",
                index: 19

            },
            {
                name: "污水泵2",
                index: 20
            },
            {
                name: "污水泵3",
                index: 21
            },
            {
                name: "污水泵4",
                index: 22
            }
        ],
        pipeNodeNames: [
            {
                index1: 23,
                index2: 28,
                index3: 35,
                index4: 33,
                index5: 43
            },
            {
                index1: 24,
                index2: 27,
                index3: 34,
                index4: 37,
                index5: 42
            },
            {
                index1: 25,
                index2: 29,
                index3: 31,
                index4: 32,
                index5: 41
            },
            {
                index1: 26,
                index2: 30,
                index3: 36,
                index4: 38,
                index5: 40
            }
        ],
        mainPipelineIndex: [
            39
        ],
        laozhaji: [
            {
                name: "捞渣机1",
                index: 52
            },
            {
                name: "捞渣机1",
                index: 50
            }
        ],
        chuansongdai: [
            {
                name: "传送带1",
                index: 56
            },
            {
                name: "传送带2",
                index: 55
            }
        ],
        qibiji: [
            {
                name: "启闭机1",
                index: 49
            },
            {
                name: "启闭机2",
                index: 48
            }
        ],
        lajichuansongji: [
            {
                name: "垃圾传送机1",
                index: 51
            },
        ]
    },

    //济川
    jichuanStation: {
        qiang: [
            {
                start: 2,
                end: 14
            }
        ],
        controlBox: [
            {
                start: 53,
                end: 56
            }
        ],
        wushuibeng: [
            {
                name: "污水泵1",
                index: 20

            },
            {
                name: "污水泵2",
                index: 21
            },
            {
                name: "污水泵3",
                index: 22
            },
            {
                name: "污水泵4",
                index: 23
            }
        ],
        pipeNodeNames: [
            {
                index1: 24,
                index2: 29,
                index3: 36,
                index4: 34,
                index5: 43
            },
            {
                index1: 25,
                index2: 28,
                index3: 35,
                index4: 38,
                index5: 42
            },
            {
                index1: 26,
                index2: 30,
                index3: 32,
                index4: 33,
                index5: 41
            },
            {
                index1: 27,
                index2: 31,
                index3: 37,
                index4: 39,
                index5: 40
            }
        ],
        mainPipelineIndex: [
            49
        ],
        laozhaji: [
            {
                name: "捞渣机1",
                index: 63
            },
            {
                name: "捞渣机1",
                index: 61
            }
        ],
        chuansongdai: [
            {
                name: "传送带1",
                index: 67
            },
            {
                name: "传送带2",
                index: 66
            }
        ],
        qibiji: [
            {
                name: "启闭机1",
                index: 58
            },
            {
                name: "启闭机2",
                index: 59
            },
            {
                name: "启闭机3",
                index: 60
            },
            {
                name: "启闭机4",
                index: 57
            }
        ],
        lajichuansongji: [
            {
                name: "垃圾传送机1",
                index: 62
            },
        ]
    },

    //新区
    newdistrictStation: {
        qiang: [
            {
                start: 2,
                end: 14
            }
        ],
        wushuibeng: [
            {
                name: "污水泵1",
                index: 18

            },
            {
                name: "污水泵2",
                index: 19
            },
            {
                name: "污水泵3",
                index: 20
            },
            {
                name: "污水泵4",
                index: 21
            }
        ],
        pipeNodeNames: [
            {
                index1: 22,
                index2: 27,
                index3: 34,
                index4: 32,
                index5: 39
            },
            {
                index1: 23,
                index2: 26,
                index3: 33,
                index4: 36,
                index5: 40
            },
            {
                index1: 24,
                index2: 28,
                index3: 30,
                index4: 31,
                index5: 41
            },
            {
                index1: 25,
                index2: 29,
                index3: 35,
                index4: 37,
                index5: 42
            }
        ],
        mainPipelineIndex: [
            38
        ],
        laozhaji: [
            {
                name: "捞渣机1",
                index: 47
            }
        ],
        chuansongdai: [
            {
                name: "传送带1",
                index: 51
            }
        ],
        qibiji: [
            {
                name: "启闭机1",
                index: 64
            },
            {
                name: "启闭机2",
                index: 65
            }
        ],
        lajichuansongji: [
            {
                name: "垃圾传送机1",
                index: 48
            }
        ]
    },

    //泰山公园
    parkStation: {
        qiang: [
            {
                start: 2,
                end: 11
            }
        ],
        controlBox: [
            {
                start: 44,
                end: 47
            }
        ],
        wushuibeng: [
            {
                name: "污水泵1",
                index: 19

            },
            {
                name: "污水泵2",
                index: 20
            },
            {
                name: "污水泵3",
                index: 21
            },
            {
                name: "污水泵4",
                index: 22
            }
        ],
        pipeNodeNames: [
            {
                index1: 23,
                index2: 28,
                index3: 35,
                index4: 33,
                index5: 43
            },
            {
                index1: 24,
                index2: 27,
                index3: 34,
                index4: 37,
                index5: 42
            },
            {
                index1: 25,
                index2: 29,
                index3: 31,
                index4: 32,
                index5: 41
            },
            {
                index1: 26,
                index2: 30,
                index3: 36,
                index4: 38,
                index5: 40
            }
        ],
        mainPipelineIndex: [
            39
        ],
        laozhaji: [
            {
                name: "捞渣机1",
                index: 52
            },
            {
                name: "捞渣机1",
                index: 50
            }
        ],
        chuansongdai: [
            {
                name: "传送带1",
                index: 56
            },
            {
                name: "传送带2",
                index: 55
            }
        ],
        qibiji: [
            {
                name: "启闭机1",
                index: 49
            },
            {
                name: "启闭机2",
                index: 48
            }
        ],
        lajichuansongji: [
            {
                name: "垃圾传送机1",
                index: 51
            },
        ]
    },

    //人民路三栋
    peopleStation: {
        qiang: [
            {
                start: 1,
                end: 9
            }
        ],
        controlBox: [
            {
                start: 25,
                end: 26
            }
        ],
        wushuibeng: [
            {
                name: "污水泵1",
                index: 12
            },
            {
                name: "污水泵2",
                index: 13
            }
        ],
        pipeNodeNames: [
            {
                index1: 14,
                index2: 17,
                index3: 20,
                index4: 18,
                index5: 24
            },
            {
                index1: 15,
                index2: 16,
                index3: 19,
                index4: 21,
                index5: 23
            }
        ],
        mainPipelineIndex: [
            22
        ],
        laozhaji: [

        ],
        qibiji: [

        ],
        lajichuansongji: [

        ]
    },

    //凤凰河
    pheonixStation: {
        qiang: [
            {
                start: 2,
                end: 11
            }
        ],
        controlBox: [
            {
                start: 49,
                end: 53
            }
        ],
        wushuibeng: [
            {
                name: "污水泵1",
                index: 18

            },
            {
                name: "污水泵2",
                index: 19
            },
            {
                name: "污水泵3",
                index: 20
            },
            {
                name: "污水泵4",
                index: 21
            },
            {
                name: "污水泵5",
                index: 22
            }
        ],
        pipeNodeNames: [
            {
                index1: 23,
                index2: 28,
                index3: 35,
                index4: 33,
                index5: 40
            },
            {
                index1: 24,
                index2: 27,
                index3: 34,
                index4: 37,
                index5: 41
            },
            {
                index1: 25,
                index2: 29,
                index3: 31,
                index4: 32,
                index5: 42
            },
            {
                index1: 26,
                index2: 30,
                index3: 36,
                index4: 38,
                index5: 43
            },
            {
                index1: 44,
                index2: 45,
                index3: 46,
                index4: 47,
                index5: 48
            }
        ],
        mainPipelineIndex: [
            39
        ],
        laozhaji: [
            {
                name: "捞渣机1",
                index: 58
            },
            {
                name: "捞渣机1",
                index: 56
            }
        ],
        chuansongdai: [
            {
                name: "传送带1",
                index: 62
            },
            {
                name: "传送带2",
                index: 61
            }
        ],
        qibiji: [
            {
                name: "启闭机1",
                index: 55
            },
            {
                name: "启闭机2",
                index: 54
            }
        ],
        lajichuansongji: [
            {
                name: "垃圾传送机1",
                index: 57
            },
        ]
    },

    //西湖翠苑
    xihucuiyuanStation: {
        qiang: [
            {
                start: 1,
                end: 9
            }
        ],
        controlBox: [
            {
                start: 25,
                end: 26
            }
        ],
        wushuibeng: [
            {
                name: "污水泵1",
                index: 12
            },
            {
                name: "污水泵2",
                index: 13
            }
        ],
        pipeNodeNames: [
            {
                index1: 14,
                index2: 17,
                index3: 20,
                index4: 18,
                index5: 24
            },
            {
                index1: 15,
                index2: 16,
                index3: 19,
                index4: 21,
                index5: 23
            }
        ],
        mainPipelineIndex: [
            22
        ],
        laozhaji: [

        ],
        qibiji: [

        ],
        lajichuansongji: [

        ]
    },

    //朝阳河
    zhaoyangriverStation: {
        qiang: [
            {
                start: 1,
                end: 9
            }
        ],
        controlBox: [
            {
                start: 25,
                end: 26
            }
        ],
        wushuibeng: [
            {
                name: "污水泵1",
                index: 12
            },
            {
                name: "污水泵2",
                index: 13
            }
        ],
        pipeNodeNames: [
            {
                index1: 14,
                index2: 17,
                index3: 20,
                index4: 18,
                index5: 24
            },
            {
                index1: 15,
                index2: 16,
                index3: 19,
                index4: 21,
                index5: 23
            }
        ],
        mainPipelineIndex: [
            22
        ],
        laozhaji: [

        ],
        qibiji: [

        ],
        lajichuansongji: [

        ]
    },

    //周山
    zhoushanriverStation: {
        qiang: [
            {
                start: 2,
                end: 11
            }
        ],
        controlBox: [
            {
                start: 49,
                end: 53
            }
        ],
        wushuibeng: [
            {
                name: "污水泵1",
                index: 18

            },
            {
                name: "污水泵2",
                index: 19
            },
            {
                name: "污水泵3",
                index: 20
            },
            {
                name: "污水泵4",
                index: 21
            },
            {
                name: "污水泵5",
                index: 22
            }
        ],
        pipeNodeNames: [
            {
                index1: 23,
                index2: 28,
                index3: 35,
                index4: 33,
                index5: 40
            },
            {
                index1: 24,
                index2: 27,
                index3: 34,
                index4: 37,
                index5: 41
            },
            {
                index1: 25,
                index2: 29,
                index3: 31,
                index4: 32,
                index5: 42
            },
            {
                index1: 26,
                index2: 30,
                index3: 36,
                index4: 38,
                index5: 43
            },
            {
                index1: 44,
                index2: 45,
                index3: 46,
                index4: 47,
                index5: 48
            }
        ],
        mainPipelineIndex: [
            39
        ],
        laozhaji: [
            {
                name: "捞渣机1",
                index: 58
            },
            {
                name: "捞渣机1",
                index: 56
            }
        ],
        chuansongdai: [
            {
                name: "传送带1",
                index: 62
            },
            {
                name: "传送带2",
                index: 61
            }
        ],
        qibiji: [
            {
                name: "启闭机1",
                index: 55
            },
            {
                name: "启闭机2",
                index: 54
            }
        ],
        lajichuansongji: [
            {
                name: "垃圾传送机1",
                index: 57
            },
        ]
    },

}


export function initWithConfig(StationName, glburl, imgUrl1, imgUrl2, bgUrl, data, dracoUrl) {
    analyticalData(StationName, glburl, imgUrl1, imgUrl2, bgUrl, data, dracoUrl);
}

export function init(glburl, bgUrl, dracoUrl) {
    var sss = document.getElementById('station');
    bustard = new Bustard(sss);
    bustard.core.addImgToBackground(bgUrl)
    var roam = bustard.use(new Bustard.Roam())
    loader = bustard.use(new Bustard.Loader());
    loader.setDraco(dracoUrl)
    var transparent = bustard.use(new Bustard.Transparent())
    transparent.activeClick = false
    sprite = bustard.use(new Bustard.Sprite({
        fontSize: 20,
        borderThickness: 5,
        scale: [1, 1, 1]
    }));
    color = bustard.use(new Bustard.Color({ isMutex: true }));
    color.activeClick = false;
    textureTool = bustard.use(new Bustard.Texture());
    Promise.all([
        loader.gltfLoadByUrl(glburl, 'station').then(value => {
            STATION_MODEL_ALL = value.children[0].children
            roam.lookAt(
                {
                    x: -1.6,
                    y: 5,
                    z: 10.5
                },
                {
                    x: -0.46,
                    y: -0.5,
                    z: 1.2
                });
            //主管线
            textureTool.addRepetitiveTextureOnMesh(STATION_MODEL_ALL[bengzhan[stationName].mainPipelineIndex], FlowImgUrl1, -0.06, 10)
            //控制箱颜色
            for (let i = bengzhan[stationName].controlBox[0].start; i <= bengzhan[stationName].controlBox[0].end; i++) {
                for (let j = 0; j <= 2; j++) {
                    color.setMeshColor(STATION_MODEL_ALL[i].children[j], 0x858590)
                }
            }
            loadData();
        })
    ]);
    modelHide = bustard.use(new Bustard.Hide());
    modelHide.activeClick = false;
    pick = bustard.use(new Bustard.Pick());
    pick.pick = function (node, point) {
        console.log(node)
        // console.log("相机位置：" + roam.curPosition().z + "," + roam.curPosition().y + "," + roam.curPosition().x);
        // console.log("焦点位置：" + roam.curTarget().z + "," + roam.curTarget().y + "," + roam.curTarget().x);
        // modelHide.hideById(node.userData.uniqId)
        // color.setColorById("station|1116_",0xFF0000)
    }
}

export function analyticalData(StationName, glburl, imgUrl1, imgUrl2, bgUrl, data, dracoUrl) {
    FlowImgUrl1 = imgUrl1;
    FlowImgUrl2 = imgUrl2;
    datas = data;
    stationName = StationName;
    init(glburl, bgUrl, dracoUrl);
}

export function loadData() {
    loadEquipmentState();
    loadPumpDate();
    addFlow();
}

export function loadEquipmentState() {
    // let equipment = ['wushuibeng','laozhaji','qibiji','lajichuansongji']
    // for (let i = 0;i < equipment.length;i++){
    //     if (bengzhan[stationName][equipment[i]].length > 0){
    //         for (let j =0;j < bengzhan[stationName][equipment[i]].length;j++){
    //             changeEquipmentState(bengzhan[stationName][equipment[i]][j].id,datas[equipment[i]].state);
    //         }
    //     }
    // }
    // 污水泵
    if (bengzhan[stationName].wushuibeng.length > 0) {
        for (let i = 0; i < bengzhan[stationName].wushuibeng.length; i++) {
            changeEquipmentState(STATION_MODEL_ALL[bengzhan[stationName].wushuibeng[i].index], datas.wushuibeng[i].state)
        }
    }
    if (bengzhan[stationName].laozhaji.length > 0) {
        for (let i = 0; i < bengzhan[stationName].laozhaji.length; i++) {
            changeEquipmentState(STATION_MODEL_ALL[bengzhan[stationName].laozhaji[i].index], datas.laozhaji[i].state)
        }
    }
    if (bengzhan[stationName].qibiji.length > 0) {
        for (let i = 0; i < bengzhan[stationName].qibiji.length; i++) {
            changeEquipmentState(STATION_MODEL_ALL[bengzhan[stationName].qibiji[i].index], datas.qibiji[i].state)
        }
    }
    if (bengzhan[stationName].lajichuansongji.length > 0) {
        for (let i = 0; i < bengzhan[stationName].lajichuansongji.length; i++) {
            changeEquipmentState(STATION_MODEL_ALL[bengzhan[stationName].lajichuansongji[i].index], datas.lajichuansongji[i].state)
        }
    }
}

export function changeEquipmentState(mesh, state) {
    if (state === 0) {
        color.setMeshColor(mesh, 0x008000)
    }
    if (state === 1) {
        color.setMeshColor(mesh, 0x808080)
    }
    if (state === 2) {
        color.setMeshColor(mesh, 0xFF0000)
    }
}

export function loadPumpDate() {
    if (bengzhan[stationName].wushuibeng.length > 0) {
        for (let i = 0; i < bengzhan[stationName].wushuibeng.length; i++) {
            let pum = STATION_MODEL_ALL[bengzhan[stationName].wushuibeng[i].index]
            if (datas.wushuibeng[i].state === 0) {
                // sprite.addText(datas.wushuibeng[i].data, [pum.position.x, (pum.position.y + 1), pum.position.z])
                sprite.addCanvas(addPumpCanvas(datas.wushuibeng[i].data), [pum.position.x, (pum.position.y + 1), pum.position.z], function (canvas, pos) {
                    // init();


                });


            }
        }
    }
}

export function addPumpCanvas(data) {
    let canvas = document.createElement("canvas");
    canvas.width = 150;
    canvas.height = 400;
    // canvas.textAlign = 'center'
    canvas.setAttribute('cursor', 'pointer');
    let ctx = canvas.getContext("2d");
    ctx.textAlign = 'center'
    ctx.lineWidth = 1;
    ctx.strokeStyle = 'rgba(25,25,112,0.7)';
    ctx.fillStyle = 'rgba(25,25,112,0.7)';
    ctx.beginPath();
    ctx.fillRect(0, 0, 150, 100);
    ctx.stroke();
    ctx.fill();
    ctx.fillStyle = '#FFFFFF';
    ctx.font = "40px Cambria";
    ctx.fillText(data + "A", 15, 70);
    // ctx.fillText("A", 85, 70);
    return canvas;
}

export function addFlow() {
    if (bengzhan[stationName].laozhaji.length > 0) {
        for (let i = 0; i < bengzhan[stationName].laozhaji.length; i++) {
            if (datas.laozhaji[i].state == 0) {
                let chuansongdai = STATION_MODEL_ALL[bengzhan[stationName].chuansongdai[i].index]
                textureTool.addRepetitiveTextureOnMesh(chuansongdai, FlowImgUrl2, 0.01, -2)
            }
        }
    }
    if (bengzhan[stationName].wushuibeng.length > 0) {
        for (let i = 0; i < bengzhan[stationName].wushuibeng.length; i++) {
            if (datas.wushuibeng[i].state == 0) {
                textureTool.addRepetitiveTextureOnMesh(STATION_MODEL_ALL[bengzhan[stationName].pipeNodeNames[i].index3], FlowImgUrl1, -0.06, 10)
                textureTool.addRepetitiveTextureOnMesh(STATION_MODEL_ALL[bengzhan[stationName].pipeNodeNames[i].index4], FlowImgUrl1, -0.06, 2)
                if (stationName == "xihucuiyuanStation" || stationName == "districtthreeStation" || stationName == "peopleStation" || stationName == "zhaoyangriverStation" || stationName == "eastwindStation") {
                    textureTool.addRepetitiveTextureOnMesh(STATION_MODEL_ALL[bengzhan[stationName].pipeNodeNames[i].index5], FlowImgUrl1, -0.06, 2)
                } else {
                    textureTool.addRepetitiveTextureOnMesh(STATION_MODEL_ALL[bengzhan[stationName].pipeNodeNames[i].index5], FlowImgUrl1, -0.06, 10)
                }
                textureTool.addRepetitiveTextureOnMesh(STATION_MODEL_ALL[bengzhan[stationName].pipeNodeNames[i].index1], FlowImgUrl1, -0.06, 10, Math.PI / 2)
                // color.setMeshColor(STATION_MODEL_ALL[bengzhan[stationName].pipeNodeNames[i].index1], 0x91B5F9)
                color.setMeshColor(STATION_MODEL_ALL[bengzhan[stationName].pipeNodeNames[i].index2], 0x91B5F9)
            }
        }
    }
    renderInterval = setInterval(render, 20)
}

export function render() {
    pick.getCore().render()
}

//销毁
export function destroyPumpStation() {
    document.getElementById('station').innerHTML = "";
    clearInterval(renderInterval)
}