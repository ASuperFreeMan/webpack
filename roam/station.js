export var bustard
export var loader
export var sprite
export var pick
export var color
export var textureTool
export var modelHide
export var FlowImgUrl1
export var FlowImgUrl2
export var datas
export var renderInterval
export var stationName
export var bengzhan = {

    //春兰
    chunlanStation: {
        wushuibeng: [
            {
                name: "污水泵1",
                id: "station|64415_",
                nodeName: '64415_'
            },
            {
                name: "污水泵2",
                id: "station|64485_",
                nodeName: '64485_'
            },
            {
                name: "污水泵3",
                id: "station|64529_",
                nodeName: '64529_'
            },
            {
                name: "污水泵4",
                id: "station|64574_",
                nodeName: '64574_'
            }
        ],
        pipeNodeNames: [
            {
                name1: "64797_",
                name2: "106472_",
                name3: "64624_",
            },
            {
                name1: "65088_",
                name2: "106364_",
                name3: "64943_",
            },
            {
                name1: "65378_",
                name2: "106556_",
                name3: "65233_",
            },
            {
                name1: "65668_",
                name2: "106640_",
                name3: "65523_",
            }
        ],
        laozhaji: [
            {
                name: "捞渣机1",
                id: "station|121617_"
            },
            {
                name: "捞渣机1",
                id: "station|102819_"
            }
        ],
        chuansongdai: [
            {
                name: "传送带1",
                nodeName: "106813_"
            },
            {
                name: "传送带2",
                nodeName: "121751_"
            }
        ],
        qibiji: [
            {
                name: "启闭机1",
                id: "station|87557_"
            },
            {
                name: "启闭机2",
                id: "station|77505_"
            }
        ],
        lajichuansongji: [
            {
                name: "垃圾传送机1",
                id: "station|123660_"
            },
        ]
    },

    //三号小区
    districtthreeStation: {
        wushuibeng: [
            {
                name: "污水泵1",
                id: "station|64392_",
                nodeName: '64392_'
            },
            {
                name: "污水泵2",
                id: "station|64463_",
                nodeName: '64463_'
            }
        ],
        pipeNodeNames: [
            {
                name1: "64687_",
                name2: "69704_",
                name3: "64514_",
            },
            {
                name1: "64978_",
                name2: "69812_",
                name3: "64833_",
            }
        ],
        laozhaji: [

        ],
        qibiji: [

        ],
        lajichuansongji: [

        ]
    },

    //东风
    eastwindStation: {
        wushuibeng: [
            {
                name: "污水泵1",
                id: "station|64393_",
                nodeName: '64393_'
            },
            {
                name: "污水泵2",
                id: "station|69099_",
                nodeName: '69099_'
            },
            {
                name: "污水泵3",
                id: "station|69934_",
                nodeName: '69934_'
            }
        ],
        pipeNodeNames: [
            {
                name1: "64642_",
                name2: "68964_",
                name3: "64469_",
            },
            {
                name1: "69293_",
                name2: "69838_",
                name3: "69148_",
            },
            {
                name1: "70128_",
                name2: "70673_",
                name3: "69983_",
            }
        ],
        laozhaji: [

        ],
        qibiji: [

        ],
        lajichuansongji: [

        ]
    },

    //鼓楼
    gulouStation: {
        wushuibeng: [
            {
                name: "污水泵1",
                id: "station|64414_",
                nodeName: '64414_'
            },
            {
                name: "污水泵2",
                id: "station|64485_",
                nodeName: '64485_'
            },
            {
                name: "污水泵3",
                id: "station|64530_",
                nodeName: '64530_'
            },
            {
                name: "污水泵4",
                id: "station|64574_",
                nodeName: '64574_'
            }
        ],
        pipeNodeNames: [
            {
                name1: "64797_",
                name2: "106472_",
                name3: "64624_",
            },
            {
                name1: "65088_",
                name2: "106364_",
                name3: "64943_",
            },
            {
                name1: "65378_",
                name2: "106556_",
                name3: "65233_",
            },
            {
                name1: "65668_",
                name2: "106640_",
                name3: "65523_",
            }
        ],
        laozhaji: [
            {
                name: "捞渣机1",
                id: "station|121617_"
            },
            {
                name: "捞渣机2",
                id: "station|102819_"
            }
        ],
        chuansongdai: [
            {
                name: "传送带1",
                nodeName: "106813_"
            },
            {
                name: "传送带2",
                nodeName: "121751_"
            }
        ],
        qibiji: [
            {
                name: "启闭机1",
                id: "station|87557_"
            },
            {
                name: "启闭机2",
                id: "station|77505_"
            }
        ],
        lajichuansongji: [
            {
                name: "垃圾传送机1",
                id: "station|123660_"
            }
        ]
    },

    //济川
    jichuanStation: {
        wushuibeng: [
            {
                name: "污水泵1",
                id: "station|64415_",
                nodeName: '64415_'
            },
            {
                name: "污水泵2",
                id: "station|64486_",
                nodeName: '64486_'
            },
            {
                name: "污水泵3",
                id: "station|64530_",
                nodeName: '64530_'
            },
            {
                name: "污水泵4",
                id: "station|64574_",
                nodeName: '64574_'
            }
        ],
        pipeNodeNames: [
            {
                name1: "64797_",
                name2: "106472_",
                name3: "64624_",
            },
            {
                name1: "65088_",
                name2: "106364_",
                name3: "64943_",
            },
            {
                name1: "65378_",
                name2: "106556_",
                name3: "65233_",
            },
            {
                name1: "65668_",
                name2: "106640_",
                name3: "65523_",
            }
        ],
        laozhaji: [
            {
                name: "捞渣机1",
                id: "station|121617_"
            },
            {
                name: "捞渣机2",
                id: "station|102819_"
            }
        ],
        chuansongdai: [
            {
                name: "传送带1",
                nodeName: "106813_"
            },
            {
                name: "传送带2",
                nodeName: "121751_"
            }
        ],
        qibiji: [
            {
                name: "启闭机1",
                id: "station|154178_"
            },
            {
                name: "启闭机2",
                id: "station|87557_"
            },
            {
                name: "启闭机3",
                id: "station|77505_"
            },
            {
                name: "启闭机4",
                id: "station|144127_"
            }
        ],
        lajichuansongji: [
            {
                name: "垃圾传送机1",
                id: "station|123660_"
            }
        ]
    },

    //新区
    newdistrictStation: {
        wushuibeng: [
            {
                name: "污水泵1",
                id: "station|64393_",
                nodeName: '64393_'
            },
            {
                name: "污水泵2",
                id: "station|64464_",
                nodeName: '64464_'
            },
            {
                name: "污水泵3",
                id: "station|64508_",
                nodeName: '64508_'
            },
            {
                name: "污水泵4",
                id: "station|64552_",
                nodeName: '64552_'
            }
        ],
        pipeNodeNames: [
            {
                name1: "64775_",
                name2: "91438_",
                name3: "64602_",
            },
            {
                name1: "65066_",
                name2: "91330_",
                name3: "64921_",
            },
            {
                name1: "65356_",
                name2: "91522_",
                name3: "65211_",
            },
            {
                name1: "65646_",
                name2: "91606_",
                name3: "65501_",
            }
        ],
        laozhaji: [
            {
                name: "捞渣机1",
                id: "station|106633_"
            }
        ],
        chuansongdai: [
            {
                name: "传送带1",
                nodeName: "91781_"
            }
        ],
        qibiji: [
            {
                name: "启闭机1",
                id: "station|87535_"
            },
            {
                name: "启闭机2",
                id: "station|77483_"
            }
        ],
        lajichuansongji: [
            {
                name: "垃圾传送机1",
                id: "station|108457_"
            }
        ]
    },

    //泰山公园
    parkStation: {
        wushuibeng: [
            {
                name: "污水泵1",
                id: "station|64414_",
                nodeName: '64414_'
            },
            {
                name: "污水泵2",
                id: "station|64484_",
                nodeName: '64484_'
            },
            {
                name: "污水泵3",
                id: "station|64528_",
                nodeName: '64528_'
            },
            {
                name: "污水泵4",
                id: "station|64573_",
                nodeName: '64573_'
            }
        ],
        pipeNodeNames: [
            {
                name1: "64796_",
                name2: "106472_",
                name3: "64623_",
            },
            {
                name1: "65087_",
                name2: "106364_",
                name3: "64942_",
            },
            {
                name1: "65377_",
                name2: "106556_",
                name3: "65232_",
            },
            {
                name1: "65667_",
                name2: "106640_",
                name3: "65522_",
            }
        ],
        laozhaji: [
            {
                name: "捞渣机1",
                id: "station|121617_"
            },
            {
                name: "捞渣机2",
                id: "station|102818_"
            }
        ],
        chuansongdai: [
            {
                name: "传送带1",
                nodeName: "106813_"
            },
            {
                name: "传送带2",
                nodeName: "121751_"
            }
        ],
        qibiji: [
            {
                name: "启闭机1",
                id: "station|87556_"
            },
            {
                name: "启闭机2",
                id: "station|77504_"
            }
        ],
        lajichuansongji: [
            {
                name: "垃圾传送机1",
                id: "station|123660_"
            }
        ]
    },

    //人民路三栋
    peopleStation: {
        wushuibeng: [
            {
                name: "污水泵1",
                id: "station|64393_",
                nodeName: '64393_'
            },
            {
                name: "污水泵2",
                id: "station|64463_",
                nodeName: '64463_'
            }
        ],
        pipeNodeNames: [
            {
                name1: "64686_",
                name2: "69703_",
                name3: "64513_",
            },
            {
                name1: "64977_",
                name2: "69812_",
                name3: "64832_",
            }
        ],
        laozhaji: [

        ],
        qibiji: [

        ],
        lajichuansongji: [

        ]
    },

    //凤凰河
    pheonixStation: {
        wushuibeng: [
            {
                name: "污水泵1",
                id: "station|134212_",
                nodeName: '134212_'
            },
            {
                name: "污水泵2",
                id: "station|133377_",
                nodeName: '133377_'
            },
            {
                name: "污水泵3",
                id: "station|132542_",
                nodeName: '132542_'
            },
            {
                name: "污水泵4",
                id: "station|131706_",
                nodeName: '131706_'
            },
            {
                name: "污水泵5",
                id: "station|64432_",
                nodeName: '64432_'
            }
        ],
        pipeNodeNames: [
            {
                name1: "134406_",
                name2: "134951_",
                name3: "134261_",
            },
            {
                name1: "133571_",
                name2: "134116_",
                name3: "133426_",
            },
            {
                name1: "132736_",
                name2: "133281_",
                name3: "132591_",
            },
            {
                name1: "131900_",
                name2: "132445_",
                name3: "131755_",
            },
            {
                name1: "64681_",
                name2: "104163_",
                name3: "64508_",
            }
        ],
        laozhaji: [
            {
                name: "捞渣机1",
                id: "station|119164_"
            },
            {
                name: "捞渣机2",
                id: "station|100618_"
            }
        ],
        chuansongdai: [
            {
                name: "传送带1",
                nodeName: "104360_"
            },
            {
                name: "传送带2",
                nodeName: "119298_"
            }
        ],
        qibiji: [
            {
                name: "启闭机1",
                id: "station|85356_"
            },
            {
                name: "启闭机2",
                id: "station|75304_"
            }
        ],
        lajichuansongji: [
            {
                name: "垃圾传送机1",
                id: "station|121207_"
            }
        ]
    },

    //西湖翠苑
    xihucuiyuanStation: {
        wushuibeng: [
            {
                name: "污水泵1",
                id: "station|64392_",
                nodeName: '64392_'
            },
            {
                name: "污水泵2",
                id: "station|64463_",
                nodeName: '64463_'
            }
        ],
        pipeNodeNames: [
            {
                name1: "64686_",
                name2: "69703_",
                name3: "64513_",
            },
            {
                name1: "64977_",
                name2: "69812_",
                name3: "64832_",
            }
        ],
        laozhaji: [

        ],
        qibiji: [

        ],
        lajichuansongji: [

        ]
    },

    //朝阳河
    zhaoyangriverStation: {
        wushuibeng: [
            {
                name: "污水泵1",
                id: "station|64393_",
                nodeName: '64393_'
            },
            {
                name: "污水泵2",
                id: "station|64464_",
                nodeName: '64464_'
            }

        ],
        pipeNodeNames: [
            {
                name1: "64687_",
                name2: "69704_",
                name3: "64514_",
            },
            {
                name1: "64978_",
                name2: "69812_",
                name3: "64833_",
            }
        ],
        laozhaji: [

        ],
        qibiji: [

        ],
        lajichuansongji: [

        ]
    },

    //周山
    zhoushanriverStation: {
        wushuibeng: [
            {
                name: "污水泵1",
                id: "station|134200_",
                nodeName: '134200_'
            },
            {
                name: "污水泵2",
                id: "station|133377_",
                nodeName: '133377_'
            },
            {
                name: "污水泵3",
                id: "station|132542_",
                nodeName: '132542_'
            },
            {
                name: "污水泵4",
                id: "station|131707_",
                nodeName: '131707_'
            },
            {
                name: "污水泵5",
                id: "station|64431_",
                nodeName: '64431_'
            }
        ],
        pipeNodeNames: [
            {
                name1: "134394_",
                name2: "134939_",
                name3: "134249_",
            },
            {
                name1: "133571_",
                name2: "134116_",
                name3: "133426_",
            },
            {
                name1: "132736_",
                name2: "133281_",
                name3: "132591_",
            },
            {
                name1: "131901_",
                name2: "132446_",
                name3: "131756_",
            },
            {
                name1: "64681_",
                name2: "104163_",
                name3: "64508_",
            }
        ],
        laozhaji: [
            {
                name: "捞渣机1",
                id: "station|119165_"
            },
            {
                name: "捞渣机2",
                id: "station|100618_"
            }
        ],
        chuansongdai: [
            {
                name: "传送带1",
                nodeName: "104361_"
            },
            {
                name: "传送带2",
                nodeName: "119299_"
            }
        ],
        qibiji: [
            {
                name: "启闭机1",
                id: "station|85356_"
            },
            {
                name: "启闭机2",
                id: "station|75304_"
            }
        ],
        lajichuansongji: [
            {
                name: "垃圾传送机1",
                id: "station|121208_"
            }
        ]
    },

}


export function initWithConfig(StationName, glburl, imgUrl1, imgUrl2, bgUrl, data) {
    analyticalData(StationName, glburl, imgUrl1, imgUrl2, bgUrl, data);
}

export function init(glburl, bgUrl) {
    var sss = document.getElementById('station');
    bustard = new Bustard(sss);
    bustard.core.addImgToBackground(bgUrl)
    var roam = bustard.use(new Bustard.Roam())
    loader = bustard.use(new Bustard.Loader());
    sprite = bustard.use(new Bustard.Sprite({
        fontSize: 20,
        borderThickness: 5,
        scale: [1, 1, 1]
    }));
    color = bustard.use(new Bustard.Color({ isMutex: true }));
    color.activeClick = false;
    textureTool = bustard.use(new Bustard.Texture());
    Promise.all([
        loader.gltfLoadByUrl(glburl, 'station').then(value => {
            roam.lookAt(
                {
                    x: -1.7740101496072087,
                    y: 4.6080794038340525,
                    z: 7.2764601327242175
                },
                {
                    x: -0.4214138276875019,
                    y: 1.3958300352096553,
                    z: 0.3464430570602419
                })
            loadData();
        })
    ]);
    modelHide = bustard.use(new Bustard.Hide());
    modelHide.activeClick = false;
    pick = bustard.use(new Bustard.Pick());
    pick.pick = function (node, point) {
        // console.log(node)
        // console.log("相机位置：" + roam.curPosition().z + "," + roam.curPosition().y + "," + roam.curPosition().x);
        // console.log("焦点位置：" + roam.curTarget().z + "," + roam.curTarget().y + "," + roam.curTarget().x);
        // modelHide.hideById(node.userData.uniqId)
        // color.setColorById("station|1116_",0xFF0000)
    }
}

export function analyticalData(StationName, glburl, imgUrl1, imgUrl2, bgUrl, data) {
    FlowImgUrl1 = imgUrl1;
    FlowImgUrl2 = imgUrl2;
    datas = data;
    stationName = StationName;
    init(glburl, bgUrl);
}

export function loadData() {
    loadEquipmentState();
    loadPumpDate();
    addFlow();
}

export function loadEquipmentState() {
    // let equipment = ['wushuibeng','laozhaji','qibiji','lajichuansongji']
    // for (let i = 0;i < equipment.length;i++){
    //     if (bengzhan[stationName][equipment[i]].length > 0){
    //         for (let j =0;j < bengzhan[stationName][equipment[i]].length;j++){
    //             changeEquipmentState(bengzhan[stationName][equipment[i]][j].id,datas[equipment[i]].state);
    //         }
    //     }
    // }
    // 污水泵
    if (bengzhan[stationName].wushuibeng.length > 0) {
        for (let i = 0; i < bengzhan[stationName].wushuibeng.length; i++) {
            changeEquipmentState(bengzhan[stationName].wushuibeng[i].id, datas.wushuibeng[i].state)
        }
    }
    if (bengzhan[stationName].laozhaji.length > 0) {
        for (let i = 0; i < bengzhan[stationName].laozhaji.length; i++) {
            changeEquipmentState(bengzhan[stationName].laozhaji[i].id, datas.laozhaji[i].state)
        }
    }
    if (bengzhan[stationName].qibiji.length > 0) {
        for (let i = 0; i < bengzhan[stationName].qibiji.length; i++) {
            changeEquipmentState(bengzhan[stationName].qibiji[i].id, datas.qibiji[i].state)
        }
    }
    if (bengzhan[stationName].lajichuansongji.length > 0) {
        for (let i = 0; i < bengzhan[stationName].lajichuansongji.length; i++) {
            changeEquipmentState(bengzhan[stationName].lajichuansongji[i].id, datas.lajichuansongji[i].state)
        }
    }
}

export function changeEquipmentState(EquipmentCode, state) {
    if (state === 0) {
        color.setColorById(EquipmentCode, 0x008000)
    }
    if (state === 1) {
        color.setColorById(EquipmentCode, 0x808080)
    }
    if (state === 2) {
        color.setColorById(EquipmentCode, 0xFF0000)
    }
}

export function loadPumpDate() {
    if (bengzhan[stationName].wushuibeng.length > 0) {
        for (let i = 0; i < bengzhan[stationName].wushuibeng.length; i++) {
            let pum = bustard.core.getNodeByName(bengzhan[stationName].wushuibeng[i].nodeName);
            if (datas.wushuibeng[i].state === 0) {
                sprite.addCanvas(addPumpCanvas(datas.wushuibeng[i].data), [pum.position.x - 0.2, (pum.position.y + 0.4), pum.position.z], function (canvas, pos) {
                    // init();
                });
            }
        }
    }
}

export function addPumpCanvas(data) {
    let canvas = document.createElement("canvas");
    canvas.width = 150;
    canvas.height = 400;
    canvas.setAttribute('cursor', 'pointer');
    let ctx = canvas.getContext("2d");
    ctx.lineWidth = 1;
    ctx.strokeStyle = 'rgba(25,25,112,0.7)';
    ctx.fillStyle = 'rgba(25,25,112,0.7)';
    ctx.beginPath();
    ctx.fillRect(0, 0, 150, 100);
    ctx.stroke();
    ctx.fill();
    ctx.fillStyle = '#FFFFFF';
    ctx.font = "40px bold 黑体";
    ctx.fillText(data, 15, 70);
    ctx.fillText("A", 85, 70);
    return canvas;
}

export function addFlow() {
    if (bengzhan[stationName].wushuibeng.length > 0) {
        for (let i = 0; i < bengzhan[stationName].wushuibeng.length; i++) {
            if (datas.wushuibeng[i].state == 0) {
                let pipe1 = bustard.core.getNodeByName(bengzhan[stationName].pipeNodeNames[i].name1)
                textureTool.addRepetitiveTexture(pipe1, FlowImgUrl1, -0.06, 20)
                color.setColorById('station|' + bengzhan[stationName].pipeNodeNames[i].name2, 0x91B5F9)
                color.setColorById('station|' + bengzhan[stationName].pipeNodeNames[i].name3, 0x91B5F9)
            }
        }
    }
    if (bengzhan[stationName].laozhaji.length > 0) {
        for (let i = 0; i < bengzhan[stationName].laozhaji.length; i++) {
            if (datas.laozhaji[i].state == 0) {
                let chuansongdai = bustard.core.getNodeByName(bengzhan[stationName].chuansongdai[i].nodeName)
                textureTool.addRepetitiveTexture(chuansongdai, FlowImgUrl2, 0.01, -2)
            }
        }
    }
    renderInterval = setInterval(render, 20)
}

export function render() {
    pick.getCore().render()
}

//销毁
export function destroyPumpStation() {
    document.getElementById('station').innerHTML = "";
    clearInterval(renderInterval)
}